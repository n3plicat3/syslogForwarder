{% extends 'base.html' %}
{% block content %}
  <h2 style="margin:0 0 12px;">Edit Configuration</h2>
  <form method="post">
    <input type="hidden" name="next" value="{{ section or 'config' }}" />
    <section class="card" style="margin-bottom:16px;">
      <h4 style="margin:0 0 8px;">Destination</h4>
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
        <label>Host<input name="host" value="{{ cfg.destination.host }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Port<input type="number" name="port" value="{{ cfg.destination.port }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Protocol
          <select name="protocol" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;">
            {% set proto = cfg.destination.protocol %}
            <option value="udp" {{ 'selected' if proto=='udp' else '' }}>udp</option>
            <option value="tcp" {{ 'selected' if proto=='tcp' else '' }}>tcp</option>
            <option value="tls" {{ 'selected' if proto=='tls' else '' }}>tls</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card" style="margin-bottom:16px;">
      <h4 style="margin:0 0 8px;">Files</h4>
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
        <label>Pattern<input name="pattern" value="{{ cfg.files.pattern }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/>
          <div class="hint" style="margin-top:4px;">Supports comma-separated patterns, e.g. <code>*.log,*.txt,*.jsonl</code></div>
        </label>
        <label>Rescan Interval (sec)<input type="number" step="0.1" name="rescan_interval_sec" value="{{ cfg.files.rescan_interval_sec }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
      </div>
      <label style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="from_beginning" {{ 'checked' if cfg.files.read_from_beginning else '' }} />
        <span>Read from beginning</span>
      </label>
    </section>

    <section class="card" style="margin-bottom:16px;">
      <h4 style="margin:0 0 8px;">Syslog</h4>
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
        <label>Facility<input name="facility" value="{{ cfg.syslog.facility }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Severity<input name="severity" value="{{ cfg.syslog.severity }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>App Name<input name="app_name" value="{{ cfg.syslog.app_name }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Host Name (override)<input name="host_name" value="{{ cfg.syslog.host_name or '' }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
      </div>
    </section>

    <section class="card" style="margin-bottom:16px;">
      <h4 style="margin:0 0 8px;">TLS (if protocol=tls)</h4>
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
        <label>CA File<input name="ca_file" value="{{ cfg.tls.ca_file or '' }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Cert File<input name="cert_file" value="{{ cfg.tls.cert_file or '' }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Key File<input name="key_file" value="{{ cfg.tls.key_file or '' }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Verify Mode
          <select name="verify_mode" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;">
            {% set vm = cfg.tls.verify_mode %}
            <option value="required" {{ 'selected' if vm=='required' else '' }}>required</option>
            <option value="optional" {{ 'selected' if vm=='optional' else '' }}>optional</option>
            <option value="none" {{ 'selected' if vm=='none' else '' }}>none</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card" style="margin-bottom:16px;">
      <h4 style="margin:0 0 8px;">Webhook Defaults</h4>
      {# Safely handle missing webhook section #}
      {% set wh = cfg.get('webhook', {}) %}
      <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
        <label>URL<input name="webhook_url" value="{{ (wh.url if wh else '') or '' }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/></label>
        <label>Method
          <select name="webhook_method" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;">
            {% set wm = (wh.method or 'POST') if wh else 'POST' %}
            <option value="POST" {{ 'selected' if wm=='POST' else '' }}>POST</option>
            <option value="PUT" {{ 'selected' if wm=='PUT' else '' }}>PUT</option>
          </select>
        </label>
        <label>Headers (JSON)
          <textarea name="webhook_headers" rows="4" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;">{{ (wh.headers|tojson if wh and wh.headers else '{}') }}</textarea>
        </label>
        <label>Messages per second
          <input type="number" step="0.1" name="webhook_mps" value="{{ wh.mps or 1 if wh else 1 }}" style="width:100%; padding:10px; background:#0f0f0f; color:var(--text); border:1px solid var(--border); border-radius:8px;"/>
        </label>
      </div>
    </section>

    <div class="controls">
      <a class="btn" href="{{ url_for('syslog_page') }}">Back</a>
      <button type="submit" class="primary">Save</button>
    </div>
  </form>
{% endblock %}
