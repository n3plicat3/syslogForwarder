{% extends 'base.html' %}
{% block content %}
  <section style="display:grid; grid-template-columns: 2fr 1fr; gap:16px; align-items:start;">
    <article class="card">
      <h3 style="margin:0 0 8px;">Live Log</h3>
      <div class="hint">Recent forwarded lines and system events</div>
      <div id="log" style="height:440px; overflow-y:auto; background:#0e0e0e; color:#e6e6e6; padding:10px; border-radius:10px; border:1px dashed var(--border); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></div>
    </article>
    <article class="card">
      <h3 style="margin:0 0 8px;">Controls</h3>
      <div class="hint">Start/stop and destination</div>
      <div class="controls" style="margin:8px 0 12px;">
        <form method="post" action="{{ url_for('start') }}">
          <button type="submit" class="primary" {{ 'disabled' if running else '' }}>Start</button>
        </form>
        <form method="post" action="{{ url_for('stop') }}">
          <button type="submit" class="secondary" {{ '' if running else 'disabled' }}>Stop</button>
        </form>
      </div>
      <div style="display:grid; grid-template-columns:auto 1fr; gap:2px 12px; font-size:13px;">
        <div class="hint">Host</div><div>{{ dest.get('host','') }}</div>
        <div class="hint">Port</div><div>{{ dest.get('port','') }}</div>
        <div class="hint">Protocol</div><div>{{ dest.get('protocol','') }}</div>
      </div>
    </article>
  </section>

  {% if request.args.get('error') %}
    <div class="card" style="margin-top:16px; border-color: var(--danger); background: rgba(220,38,38,0.08);">
      <strong style="color:var(--danger);">Error:</strong>
      <span>{{ request.args.get('error') }}</span>
    </div>
  {% endif %}
  {% if request.args.get('uploaded') %}
    <div class="card" style="margin-top:16px; border-color: var(--success); background: rgba(48,209,88,0.08);">
      <strong style="color:var(--success);">Uploaded:</strong>
      <span>{{ request.args.get('uploaded') }}</span>
      <span class="hint">Forwarding lines as syslog messagesâ€¦</span>
    </div>
  {% endif %}

  <section style="display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px;">
    <article class="card">
      <h4 style="margin:0 0 8px;">Upload .log File</h4>
      <div class="upload-box" id="uploadBoxSyslog">
        <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="uploadFormSyslog">
          <input type="hidden" name="context" value="syslog" />
          <input type="file" name="file" accept=".log" />
          <div class="controls">
            <button type="submit" class="primary" id="uploadBtnSyslog">Upload</button>
            <span class="hint">Only .log files are allowed here.</span>
          </div>
        </form>
      </div>
    </article>

    <article class="card">
      <h4 style="margin:0 0 8px;">Watched Files <span class="hint">pattern: {{ cfg.get('files',{}).get('pattern','*.log') }}</span></h4>
      {% if files %}
        <ul style="list-style:none; padding:0; margin:8px 0 0;">
          {% for f in files %}
            <li style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed var(--border);">
              <code style="color:#eaeaea;">{{ f }}</code>
              <a class="btn" href="{{ url_for('downloads', filename=f) }}">Download</a>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="hint">No files match in the current folder.</div>
      {% endif %}
    </article>

    
  </section>

  <script>
    const log = document.getElementById('log');
    function append(line) {
      const atBottom = (log.scrollTop + log.clientHeight) >= (log.scrollHeight - 5);
      const div = document.createElement('div');
      div.className = 'line';
      div.textContent = line;
      log.appendChild(div);
      if (log.childElementCount > 2000) {
        for (let i = 0; i < 500; i++) { if (log.firstChild) log.removeChild(log.firstChild); }
      }
      if (atBottom) { log.scrollTop = log.scrollHeight; }
    }
    const evt = new EventSource('{{ url_for('events') }}');
    evt.onmessage = (e) => {
      try {
        const d = JSON.parse(e.data);
        if (d.type === 'status') {
          document.getElementById('statusText').textContent = d.status === 'started' ? 'Running' : 'Stopped';
          const dot = document.getElementById('statusDot');
          if (d.status === 'started') dot.classList.add('running'); else dot.classList.remove('running');
        }
        if (d.type === 'line') { append(`[tail] ${d.filename || ''} ${d.message}`); }
        
        if (d.type === 'upload') { append(`[upload] ${d.filename} (${d.size||'?'} bytes)`); }
        if (d.type && d.type.startsWith('webhook')) { append(`[webhook] ${d.type}`); }
      } catch (_) {}
    };
    // Jiggle upload box briefly before submitting
    (function() {
      const form = document.getElementById('uploadFormSyslog');
      const box = document.getElementById('uploadBoxSyslog');
      if (form && box) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          box.classList.remove('shake');
          // Force reflow to restart animation
          void box.offsetWidth;
          box.classList.add('shake');
          setTimeout(() => form.submit(), 280);
        });
      }
    })();
  </script>
{% endblock %}
